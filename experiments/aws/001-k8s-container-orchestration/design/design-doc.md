# EKS コンテナオーケストレーション 設計ドキュメント

## 決定事項サマリー

| 決定日 | 分野 | 選択技術 | 理由 |
|--------|------|----------|------|
| 2024-12-28 | Container Orchestration | Amazon EKS | AWS統合とマネージド運用 |
| 2024-12-28 | Node Management | Managed Node Groups | 運用負荷軽減 |
| 2024-12-28 | Instance Type | t3.small | 実験レベルでのコスト最重視 |
| 2024-12-28 | Load Balancer | Application Load Balancer | L7機能とEKS統合 |
| 2024-12-28 | Monitoring | CloudWatch Container Insights | AWS標準ソリューション |

---

## 0. コンテナオーケストレーション採用判断

### コンテナオーケストレーションを検討すべきユースケース

**高優先度（オーケストレーション推奨）**:
- **マイクロサービスアーキテクチャ**: 複数の独立したサービスの協調運用
- **高可用性要求**: 99.9%以上のアップタイム要求がある本格運用
- **動的スケーリング**: トラフィック変動に応じた自動的なリソース調整
- **多環境デプロイ**: 開発・ステージング・本番環境の一貫した管理
- **CI/CD統合**: 継続的インテグレーション・デプロイメントの自動化
- **リソース効率化**: CPU・メモリの効率的な利用とコスト最適化

**中優先度（検討価値あり）**:
- **複数チーム開発**: 異なるチームが独立してサービスを開発・運用
- **コンプライアンス要件**: セキュリティ・監査ログの厳格な管理
- **障害分離**: 一部のサービス障害が全体に影響しない設計
- **技術スタック多様化**: 異なる言語・フレームワークの混在
- **段階的移行**: レガシーシステムからの段階的モダナイゼーション

**低優先度（シンプルな選択肢を検討）**:
- **シンプルなWebアプリ**: 単一のアプリケーションで完結
- **プロトタイプ開発**: 短期間での検証が目的
- **小規模チーム**: 1-2名での開発・運用
- **静的コンテンツ**: 主にCDNで配信可能なコンテンツ
- **バッチ処理のみ**: リアルタイム性が不要な定期処理

### 代替技術との比較

| 要件 | サーバーレス | コンテナ | 仮想マシン | 推奨ケース |
|------|-------------|----------|-----------|-----------|
| 起動速度 | ◎ | ○ | △ | 短時間処理・イベント駆動 |
| スケーラビリティ | ◎ | ○ | △ | 急激なトラフィック変動 |
| 運用負荷 | ◎ | ○ | △ | 小規模チーム・プロトタイプ |
| カスタマイズ性 | △ | ○ | ◎ | 特殊な環境・レガシー統合 |
| コスト予測性 | △ | ○ | ◎ | 安定したワークロード |
| マルチクラウド | △ | ○ | ○ | ベンダーロックイン回避 |

### 実装判断フローチャート

```
アプリケーション要件確認
          ↓
   シングルサービス？ → Yes → サーバーレス検討
          ↓ No
   マイクロサービス？ → Yes → コンテナオーケストレーション
          ↓ No
   スケーリング要件？ → 高 → コンテナオーケストレーション
          ↓ 低
   チーム規模・運用？ → 小 → サーバーレス
          ↓ 大
   技術的制約？ → 特殊 → 仮想マシン
          ↓ 標準
   → コンテナオーケストレーション
```

---

## 1. コンテナオーケストレーション基盤

### 決定: Amazon EKS を採用

**選択肢**:
- Amazon EKS (Elastic Kubernetes Service)
- Amazon ECS (Elastic Container Service)
- セルフマネージドKubernetes (EC2上)

**判断理由**:
- **学習目的**: Kubernetesエコシステムの理解が主目的
- **AWS統合**: VPC、IAM、CloudWatchとのネイティブ統合
- **マネージド運用**: Control Planeの運用負荷なし
- **将来性**: オンプレミスやマルチクラウド展開時の移植性

**トレードオフ**:
- **コスト**: ECSより高い（$0.10/hour）
- **複雑性**: ECSよりKubernetesの学習コストが高い
- **運用**: セルフマネージドより制約がある

---

## 2. ノード管理方式

### 決定: Managed Node Groups を採用

**選択肢**:
- Managed Node Groups
- Self-managed Node Groups
- AWS Fargate for EKS

**判断理由**:
- **運用簡素化**: パッチ適用やAMI更新の自動化
- **Auto Scaling**: ClusterAutoscalerとの統合
- **コスト効率**: EC2料金のみ（Fargateより安価）
- **学習適性**: 実験用途に適したバランス

**トレードオフ**:
- **カスタマイズ性**: セルフマネージドより制限
- **起動時間**: Fargateより遅い
- **ノード管理**: 一定の運用負荷は残る

---

## 3. インスタンスタイプ選択

### 決定: t3.small を採用

**選択肢**:
- t3.small (2 vCPU, 2GB RAM)
- t3.medium (2 vCPU, 4GB RAM)
- m5.large (2 vCPU, 8GB RAM)

**判断理由**:
- **コスト最重視**: 実験レベルでは最低限のコストで検証
- **時間単価**: 約$0.02/hour（t3.mediumの約半額）
- **学習目的**: Kubernetesの基本機能理解には十分
- **バースト性能**: t3のCPUクレジット機能で一時的な負荷対応
- **スケーラビリティ**: 不足時はAuto Scalingでノード数増加

**制約とリスク**:
- **メモリ制限**: 2GBは複数Pod実行時に制約となる可能性
- **本格運用不適**: プロダクション用途には明らかに不十分
- **パフォーマンス**: 負荷テスト等は制限される
- **システムリソース**: OS・Kubernetesが消費する分を考慮必要

**実験での妥協点**:
- システム動作確認が主目的
- パフォーマンス測定は参考程度
- 必要に応じてインスタンスタイプ変更可能

---

## 4. ロードバランサー設計

### 決定: Application Load Balancer を採用

**選択肢**:
- Application Load Balancer (ALB)
- Network Load Balancer (NLB)
- Classic Load Balancer

**判断理由**:
- **L7機能**: HTTP/HTTPSの高度なルーティング
- **EKS統合**: AWS Load Balancer Controllerサポート
- **コスト効率**: 実験用途に適した料金体系
- **監視**: CloudWatchとの統合

**将来検討**:
- **NLB**: 高パフォーマンス要求時
- **Ingress Controller**: NGINXやIstio検討

---

## 5. 監視・ログ戦略

### 決定: CloudWatch Container Insights を採用

**選択肢**:
- CloudWatch Container Insights
- Prometheus + Grafana
- Datadog
- 監視なし

**判断理由**:
- **AWS統合**: 追加設定なしで基本メトリクス取得
- **学習コスト**: AWSエコシステム内で完結
- **実験適性**: 無料利用枠で基本監視可能
- **将来拡張**: より高度な監視への移行が容易

**制約**:
- **機能制限**: Prometheusほど柔軟ではない
- **カスタムメトリクス**: 追加コストが発生
- **ベンダーロックイン**: AWS依存

---

## 6. ネットワーク設計

### 決定: パブリック/プライベート サブネット分離

**選択肢**:
- パブリックサブネットのみ
- プライベートサブネットのみ
- パブリック/プライベート分離

**判断理由**:
- **セキュリティ**: Workerノードの外部露出回避
- **ベストプラクティス**: 標準的なEKS構成
- **学習価値**: 実際の運用に近い構成
- **将来拡張**: プロダクション移行時の基盤

**コスト影響**:
- **NAT Gateway**: 月額約$45の追加コスト
- **実験妥当性**: セキュリティ学習のための必要投資

---

## 7. アプリケーション選択

### 決定: Nginx ベースのシンプルWebアプリ

**選択肢**:
- 静的コンテンツ (Nginx)
- Nodejs アプリケーション
- マイクロサービス構成

**判断理由**:
- **シンプル性**: Kubernetesの基本機能に集中
- **軽量**: リソース使用量が最小
- **検証容易**: HTTP応答でデプロイ確認が簡単
- **拡張性**: 将来的な機能追加が容易

---

## 8. Infrastructure as Code

### 決定: Terraform を採用

**選択肢**:
- AWS CloudFormation
- Terraform
- AWS CDK
- kubectl + YAML

**判断理由**:
- **マルチクラウド**: 将来的な他クラウド実験への対応
- **エコシステム**: 豊富なプロバイダーとモジュール
- **状態管理**: terraform stateによる変更追跡
- **学習価値**: 業界標準ツールの習得

**運用方針**:
- **状態管理**: ローカルstate（実験用）
- **モジュール化**: 再利用可能な構成
- **バージョン管理**: Gitによる変更履歴

---

## 9. セキュリティ方針

### 決定: 実験用最小限セキュリティ

**実装範囲**:
- ✅ IAM Role最小権限
- ✅ プライベートサブネット配置
- ✅ Security Group制限
- ❌ TLS/SSL設定
- ❌ Network Policies
- ❌ Pod Security Standards

**判断理由**:
- **学習集中**: コンテナオーケストレーションに注力
- **複雑性回避**: セキュリティは別実験で深掘り
- **実験効率**: 最小限でも実用的な構成

**将来課題**:
- TLS termination実験
- Kubernetes RBAC詳細設計
- ネットワークセキュリティ強化

---

## 10. 実験成功指標

### 決定: 実用的な動作確認を重視

**技術指標**:
- クラスター起動時間 < 15分
- アプリケーションデプロイ < 5分
- Auto Scaling動作確認
- 外部アクセス可能性

**学習指標**:
- Kubernetesリソース理解
- AWS統合メカニズム把握
- Terraform運用習得
- トラブルシューティング経験

**判断理由**:
- **実践重視**: 理論より動作する環境構築
- **時間効率**: 短期間での成果確認
- **継続性**: 次実験への知見蓄積

---

## 振り返りと改善点

### 今回の実験で検証したい仮説
1. **EKS学習効率**: マネージドサービスでKubernetes理解は十分深まるか
2. **AWS統合価値**: EKSとAWSサービス統合のメリットは実感できるか  
3. **運用負荷**: Terraformによるコード化で運用は楽になるか
4. **コスト妥当性**: 学習用途でのEKSコストは妥当か

### 次回実験への示唆
- より複雑なアプリケーション（マイクロサービス）
- セキュリティ設定の詳細検証
- 他オーケストレーション技術（ECS、GKE）との比較
- 本格的なCI/CD統合